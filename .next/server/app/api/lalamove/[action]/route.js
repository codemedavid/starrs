"use strict";(()=>{var e={};e.id=202,e.ids=[202],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5565:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>h,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>c,staticGenerationBailout:()=>g});var o={};r.r(o),r.d(o,{OPTIONS:()=>OPTIONS,POST:()=>POST,runtime:()=>d}),r(8976);var a=r(884),n=r(6132),s=r(5798);let i={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"},respond=(e,t=200)=>s.Z.json(e,{status:t,headers:i}),getEnv=e=>{let t=process.env[e];if(!t)throw Error(`Missing env var ${e}`);return t},signPayload=async(e,t,r,o)=>{let a=new Date().getTime().toString(),n=new TextEncoder,s=await crypto.subtle.importKey("raw",n.encode(o),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),i=`${a}\r
${e}\r
${t}\r
\r
${r}`,d=await crypto.subtle.sign("HMAC",s,n.encode(i)),u=Buffer.from(d).toString("hex");return{timestamp:a,signature:u}},getLanguageForMarket=e=>({HK:"en_HK",SG:"en_SG",TH:"th_TH",PH:"en_PH",TW:"zh_TW",MY:"ms_MY",VN:"vi_VN"})[e]||"en_US",createStops=(e,t,r,o)=>[{coordinates:{lat:e.storeLatitude.toString(),lng:e.storeLongitude.toString()},address:e.storeAddress},{coordinates:{lat:r.lat.toString(),lng:r.lng.toString()},address:t}],buildUpstreamUrl=(e,t)=>`${t?"https://rest.sandbox.lalamove.com/v3":"https://rest.lalamove.com/v3"}${e}`,proxyRequest=async(e,t,r,o,a="POST")=>{let n=getEnv("LALAMOVE_API_SECRET"),s=getEnv("LALAMOVE_API_KEY"),i="GET"===a?"":JSON.stringify(t),d=`/v3${e}`,{signature:u,timestamp:l}=await signPayload(a,d,i,n),c=buildUpstreamUrl(e,o),p=await fetch(c,{method:a,headers:{"Content-Type":"application/json; charset=utf-8",Market:r,Authorization:`hmac ${s}:${l}:${u}`,Accept:"application/json"},..."GET"!==a&&{body:i}}),m=await p.text();return p.ok?{data:JSON.parse(m)}:(console.error("Lalamove upstream error",{status:p.status,body:m,url:c,payload:t}),{error:m||"Lalamove upstream error",status:p.status})},buildConfig=e=>{if(!e)return null;let t=String(e.market||""),r=String(e.serviceType||""),o=String(e.storeName||""),a=String(e.storePhone||""),n=String(e.storeAddress||""),s=Number(e.storeLatitude),i=Number(e.storeLongitude),d=!!e.sandbox;return!t||!r||!o||!a||!n||Number.isNaN(s)||Number.isNaN(i)?null:{market:t,serviceType:r,sandbox:d,storeName:o,storePhone:a,storeAddress:n,storeLatitude:s,storeLongitude:i}},handleQuote=async(e,t)=>{let r=String(e.deliveryAddress||""),o=Number(e.deliveryLat),a=Number(e.deliveryLng);if(!r||Number.isNaN(o)||Number.isNaN(a))return respond({error:"Missing delivery fields"},400);let n=getLanguageForMarket(t.market),s={data:{serviceType:t.serviceType,language:n,stops:createStops(t,r,{lat:o,lng:a},n),item:{quantity:"1",weight:"LESS_THAN_3_KG",categories:["FOOD_DELIVERY"],handlingInstructions:["KEEP_UPRIGHT"]}}},i=await proxyRequest("/quotations",s,t.market,t.sandbox);return"error"in i?respond({error:i.error},i.status||500):respond({quotationId:i.data.data?.quotationId,price:i.data.data?.priceBreakdown?.total,currency:i.data.data?.priceBreakdown?.currency,expiresAt:i.data.data?.expiresAt})},handleOrder=async(e,t)=>{let r;let o=String(e.quotationId||""),a=String(e.recipientName||""),n=String(e.recipientPhone||"");if(!o||!a||!n)return respond({error:"Missing order fields"},400);let normalizePhone=e=>{if(!e)return e;let t=e.replace(/\D/g,"");return t?t.startsWith("63")?`+${t}`:t.startsWith("0")?`+63${t.slice(1)}`:(t.startsWith("9"),`+63${t}`):e},s=e.senderStopId,i=e.recipientStopId,d=!1;if(!s||!i)try{let e=await proxyRequest(`/quotations/${o}`,{},t.market,t.sandbox,"GET");if("error"in e)return console.error("Failed to fetch quotation:",e.error),respond({error:`Failed to fetch quotation: ${e.error}`},e.status||500);let a=e.data?.data||e.data;console.log("Quotation response structure:",JSON.stringify(a,null,2));let n=a?.expiresAt,u=new Date;if(n){let e=new Date(n);if(u>e)return console.error("Quotation has expired:",{quotationId:o,expiresAt:n,currentTime:u.toISOString(),timeDifference:u.getTime()-e.getTime()}),respond({error:`Quotation has expired. Expired at ${n}. Please request a new quotation.`},400)}let l=a?.scheduleAt;if(r=l,l){let e=new Date(l),t=e.getTime()-u.getTime();if(e<u){let e=Math.abs(t/6e4);if(!(e<=10))return console.error("Quotation schedule time is too far in the past:",{quotationId:o,scheduleAt:l,currentTime:u.toISOString(),minutesPast:e.toFixed(2)}),respond({error:`Quotation schedule time (${l}) is too far in the past (${e.toFixed(0)} minutes). Please request a new quotation for immediate delivery.`},400);console.warn("Quotation schedule time is in the past but within tolerance, treating as immediate delivery:",{quotationId:o,scheduleAt:l,currentTime:u.toISOString(),minutesPast:e.toFixed(2)}),d=!1}else{let e=t/36e5;e>24&&console.warn("Quotation schedule time is more than 24 hours away:",{quotationId:o,scheduleAt:l,hoursUntilSchedule:e}),d=!0,console.log("Using scheduled quotation:",{quotationId:o,scheduleAt:l,hoursUntilSchedule:e.toFixed(2)})}}let c=a?.stops||a?.data?.stops||[];if(s=c[0]?.stopId||c[0]?.id||"",i=c[1]?.stopId||c[1]?.id||"",!s||!i)return console.error("Missing stop IDs in quotation:",{quotationId:o,stops:c,quotationStructure:Object.keys(a||{})}),respond({error:"Failed to extract stop IDs from quotation. Please check quotation response structure."},500)}catch(e){return console.error("Error fetching quotation:",e),respond({error:"Failed to fetch quotation for stop IDs"},500)}let u=normalizePhone(t.storePhone),l=normalizePhone(n),c={data:{quotationId:o,sender:{stopId:s,name:t.storeName,phone:u},recipients:[{stopId:i,name:a,phone:l,remarks:e.recipientRemarks||""}],isPODEnabled:!0,metadata:e.metadata||{}}};d&&r&&(c.data.scheduleAt=r),console.log("Lalamove order payload:",{quotationId:o,senderStopId:s,recipientStopId:i,senderPhone:u,recipientPhone:l});let p=await proxyRequest("/orders",c,t.market,t.sandbox);return"error"in p?respond({error:p.error},p.status||500):respond({orderId:p.data.data?.orderId,status:p.data.data?.status,shareLink:p.data.data?.shareLink,driverId:p.data.data?.driverId})},d="nodejs";async function OPTIONS(){return new s.Z(null,{status:204,headers:i})}async function POST(e,{params:t}){let r;let o=t.action;if("quote"!==o&&"order"!==o)return respond({error:"Action not supported"},405);try{r=await e.json()}catch(e){return respond({error:"Invalid JSON payload"},400)}let a=buildConfig(r);return a?"quote"===o?handleQuote(r,a):handleOrder(r,a):respond({error:"Invalid delivery store configuration"},400)}let u=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/lalamove/[action]/route",pathname:"/api/lalamove/[action]",filename:"route",bundlePath:"app/api/lalamove/[action]/route"},resolvedPagePath:"/Users/codemedavid/Documents/starrs/Starr-s-Famous-Shakes/app/api/lalamove/[action]/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:l,staticGenerationAsyncStorage:c,serverHooks:p,headerHooks:m,staticGenerationBailout:g}=u,h="/api/lalamove/[action]/route"}};var t=require("../../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[955],()=>__webpack_exec__(5565));module.exports=r})();