"use strict";(()=>{var e={};e.id=146,e.ids=[146],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},4067:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>c,originalPathname:()=>v,requestAsyncStorage:()=>l,routeModule:()=>_,serverHooks:()=>m,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>p});var a={};t.r(a),t.d(a,{GET:()=>GET,POST:()=>POST,runtime:()=>d}),t(8976);var o=t(884),i=t(6132),s=t(5798),n=t(5327);let d="nodejs";async function GET(e){try{let r=e.nextUrl.searchParams,t={},a=r.get("status"),o=r.get("service_type"),i=r.get("date_from"),d=r.get("date_to"),_=r.get("search");a&&(t.status=a),o&&(t.service_type=o),i&&(t.date_from=i),d&&(t.date_to=d),_&&(t.search=_);let l=n.RU.from("orders").select(`
        *,
        order_items (*)
      `).order("created_at",{ascending:!1});if(t.status&&(l=l.eq("status",t.status)),t.service_type&&(l=l.eq("service_type",t.service_type)),t.date_from&&(l=l.gte("created_at",t.date_from)),t.date_to&&(l=l.lte("created_at",t.date_to)),t.search){let e=t.search.toLowerCase();l=l.or(`order_number.ilike.%${e}%,customer_name.ilike.%${e}%,contact_number.ilike.%${e}%`)}let{data:u,error:m}=await l;if(m)return console.error("Error fetching orders:",m),s.Z.json({error:"Failed to fetch orders",details:m.message},{status:500});let c=(u||[]).map(e=>({id:e.id,order_number:e.order_number,customer_name:e.customer_name,contact_number:e.contact_number,service_type:e.service_type,address:e.address,landmark:e.landmark,pickup_time:e.pickup_time,party_size:e.party_size,dine_in_time:e.dine_in_time,payment_method:e.payment_method,reference_number:e.reference_number,status:e.status,total:Number(e.total),notes:e.notes,customer_ip:e.customer_ip,created_at:e.created_at,updated_at:e.updated_at,completed_at:e.completed_at,delivery_fee:e.delivery_fee?Number(e.delivery_fee):null,lalamove_quotation_id:e.lalamove_quotation_id,lalamove_order_id:e.lalamove_order_id,lalamove_status:e.lalamove_status,lalamove_tracking_url:e.lalamove_tracking_url,order_items:e.order_items?.map(e=>({id:e.id,order_id:e.order_id,menu_item_id:e.menu_item_id,menu_item_name:e.menu_item_name,quantity:e.quantity,unit_price:Number(e.unit_price),total_price:Number(e.total_price),selected_variation:e.selected_variation,selected_add_ons:e.selected_add_ons,created_at:e.created_at}))||[]}));return s.Z.json({orders:c},{status:200})}catch(e){return console.error("Unexpected error in GET /api/orders:",e),s.Z.json({error:"Internal server error"},{status:500})}}async function POST(e){try{let r=await e.json(),t=(0,n.H9)(e),{cartItems:a,customerName:o,contactNumber:i,serviceType:d,paymentMethod:_,total:l,options:u}=r;if(!a||!Array.isArray(a)||0===a.length)return s.Z.json({error:"Cart items are required"},{status:400});if(!o||!i||!d||!_||void 0===l)return s.Z.json({error:"Missing required fields"},{status:400});let{data:m,error:c}=await n.RU.rpc("generate_order_number");if(c||!m)return console.error("Error generating order number:",c),s.Z.json({error:"Failed to generate order number"},{status:500});let{data:p,error:v}=await n.RU.from("orders").insert({order_number:m,customer_name:o,contact_number:i,service_type:d,address:u?.address||null,landmark:u?.landmark||null,pickup_time:u?.pickupTime||null,party_size:u?.partySize||null,dine_in_time:u?.dineInTime||null,payment_method:_,reference_number:u?.referenceNumber||null,status:"pending",total:l,delivery_fee:u?.deliveryFee??null,lalamove_quotation_id:u?.lalamoveQuotationId||null,lalamove_order_id:null,lalamove_status:null,lalamove_tracking_url:null,notes:u?.notes||null,customer_ip:t}).select().single();if(v||!p)return console.error("Error creating order:",v),s.Z.json({error:"Failed to create order",details:v?.message||"Order creation failed"},{status:500});let f=a.map(e=>{let r=null;if(e.id){let t=e.id.match(/^([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);t&&t[1]&&(r=t[1])}return{order_id:p.id,menu_item_id:r,menu_item_name:e.name,quantity:e.quantity,unit_price:e.totalPrice,total_price:e.totalPrice*e.quantity,selected_variation:e.selectedVariation||null,selected_add_ons:e.selectedAddOns||null}}),{error:y}=await n.RU.from("order_items").insert(f);if(y)return console.error("Error creating order items:",y),await n.RU.from("orders").delete().eq("id",p.id),s.Z.json({error:"Failed to create order items",details:y.message},{status:500});let{data:b,error:g}=await n.RU.from("orders").select(`
        *,
        order_items (*)
      `).eq("id",p.id).single();if(g||!b)return console.error("Error fetching complete order:",g),s.Z.json({error:"Order created but failed to fetch details"},{status:500});let k={id:b.id,order_number:b.order_number,customer_name:b.customer_name,contact_number:b.contact_number,service_type:b.service_type,address:b.address,landmark:b.landmark,pickup_time:b.pickup_time,party_size:b.party_size,dine_in_time:b.dine_in_time,payment_method:b.payment_method,reference_number:b.reference_number,status:b.status,total:Number(b.total),notes:b.notes,customer_ip:b.customer_ip,created_at:b.created_at,updated_at:b.updated_at,completed_at:b.completed_at,delivery_fee:b.delivery_fee?Number(b.delivery_fee):null,lalamove_quotation_id:b.lalamove_quotation_id,lalamove_order_id:b.lalamove_order_id,lalamove_status:b.lalamove_status,lalamove_tracking_url:b.lalamove_tracking_url,order_items:b.order_items?.map(e=>({id:e.id,order_id:e.order_id,menu_item_id:e.menu_item_id,menu_item_name:e.menu_item_name,quantity:e.quantity,unit_price:Number(e.unit_price),total_price:Number(e.total_price),selected_variation:e.selected_variation,selected_add_ons:e.selected_add_ons,created_at:e.created_at}))||[]};return s.Z.json({order:k},{status:201})}catch(e){return console.error("Unexpected error in POST /api/orders:",e),s.Z.json({error:"Internal server error"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"/Users/codemedavid/Documents/starrs/Starr-s-Famous-Shakes/app/api/orders/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:l,staticGenerationAsyncStorage:u,serverHooks:m,headerHooks:c,staticGenerationBailout:p}=_,v="/api/orders/route"}};var r=require("../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[955,771,97],()=>__webpack_exec__(4067));module.exports=t})();