"use strict";(()=>{var e={};e.id=87,e.ids=[87],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},8594:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>c,originalPathname:()=>v,requestAsyncStorage:()=>_,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>p});var a={};t.r(a),t.d(a,{GET:()=>GET,PATCH:()=>PATCH,runtime:()=>l}),t(8976);var o=t(884),i=t(6132),s=t(5798),n=t(5327);let readEnvNumber=e=>{if(!e)return;let r=Number(e);return Number.isFinite(r)?r:void 0},buildLalamoveConfig=e=>{if(!e)return null;let r=e.lalamove_market?.trim(),t=e.lalamove_service_type?.trim(),a=e.lalamove_store_name?.trim(),o=e.lalamove_store_phone?.trim(),i=e.lalamove_store_address?.trim(),s=readEnvNumber(e.lalamove_store_latitude??void 0),n=readEnvNumber(e.lalamove_store_longitude??void 0),l=e.lalamove_sandbox?.trim().toLowerCase()!=="false";return r&&t&&a&&o&&i&&void 0!==s&&void 0!==n?{market:r,serviceType:t,sandbox:void 0===l||l,storeName:a,storePhone:o,storeAddress:i,storeLatitude:s,storeLongitude:n}:null},l="nodejs";async function getSiteSettings(){try{let{data:e,error:r}=await n.RU.from("site_settings").select("*").order("id");if(r)return console.error("Error fetching site settings:",r),null;let t={};(e||[]).forEach(e=>{t[e.id]=e.value});let getValue=(e,r="")=>t[e]??r;return{site_name:getValue("site_name","Beracah Cafe"),site_logo:getValue("site_logo",""),site_description:getValue("site_description",""),currency:getValue("currency","PHP"),currency_code:getValue("currency_code","PHP"),lalamove_market:getValue("lalamove_market",""),lalamove_service_type:getValue("lalamove_service_type",""),lalamove_sandbox:getValue("lalamove_sandbox","true"),lalamove_api_key:getValue("lalamove_api_key",""),lalamove_api_secret:getValue("lalamove_api_secret",""),lalamove_store_name:getValue("lalamove_store_name",""),lalamove_store_phone:getValue("lalamove_store_phone",""),lalamove_store_address:getValue("lalamove_store_address",""),lalamove_store_latitude:getValue("lalamove_store_latitude",""),lalamove_store_longitude:getValue("lalamove_store_longitude","")}}catch(e){return console.error("Error fetching site settings:",e),null}}async function createLalamoveOrder(e,r,t,a,o,i){try{let s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlud2F6dGhwc3FtamRncWloeHVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Njg1MDYsImV4cCI6MjA3OTQ0NDUwNn0.F0bbR4I8dMhjhlNvTdTp3nScoWS5mHVdq85IdB7XeRQ";if(!s)throw Error("Missing NEXT_PUBLIC_SUPABASE_ANON_KEY");let normalizePhone=e=>{if(!e)return e;let r=e.replace(/\D/g,"");return r?r.startsWith("63")?`+${r}`:r.startsWith("0")?`+63${r.slice(1)}`:(r.startsWith("9"),`+63${r}`):e},n=normalizePhone(t),l=normalizePhone(a.storePhone),getProxyBase=()=>"/api/lalamove",d=await fetch((e=>{let r=getProxyBase(),t=e.startsWith("/")?e:`/${e}`,a=r.replace(/\/$/,"");if(a.startsWith("http://")||a.startsWith("https://"))return`${a}${t}?apikey=${encodeURIComponent(s)}`;let o=process.env.NEXT_PUBLIC_APP_URL||process.env.NEXT_PUBLIC_SITE_URL;if(!o&&i){let e=i.headers.get("host"),r=i.headers.get("x-forwarded-proto")||"http";e&&(o=`${r}://${e}`)}return o||(o="http://localhost:3000"),`${o}${a}${t}?apikey=${encodeURIComponent(s)}`})("/order"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,apikey:s},body:JSON.stringify({quotationId:e,recipientName:r,recipientPhone:n,market:a.market,sandbox:a.sandbox,storeName:a.storeName,storePhone:l,storeAddress:a.storeAddress,storeLatitude:a.storeLatitude,storeLongitude:a.storeLongitude,serviceType:a.serviceType,metadata:{orderId:o}})});if(!d.ok){let e=await d.text();throw Error(e||"Failed to create Lalamove order")}let _=await d.json();return{orderId:_.orderId,status:_.status,shareLink:_.shareLink,driverId:_.driverId}}catch(e){return console.error("Error creating Lalamove order:",e),null}}async function GET(e,{params:r}){try{let{id:e}=r;if(!e)return s.Z.json({error:"Order ID is required"},{status:400});let{data:t,error:a}=await n.RU.from("orders").select(`
        *,
        order_items (*)
      `).eq("id",e).single();if(a)return console.error("Error fetching order:",a),s.Z.json({error:"Order not found",details:a.message},{status:404});if(!t)return s.Z.json({error:"Order not found"},{status:404});let o={id:t.id,order_number:t.order_number,customer_name:t.customer_name,contact_number:t.contact_number,service_type:t.service_type,address:t.address,landmark:t.landmark,pickup_time:t.pickup_time,party_size:t.party_size,dine_in_time:t.dine_in_time,payment_method:t.payment_method,reference_number:t.reference_number,status:t.status,total:Number(t.total),notes:t.notes,customer_ip:t.customer_ip,created_at:t.created_at,updated_at:t.updated_at,completed_at:t.completed_at,delivery_fee:t.delivery_fee?Number(t.delivery_fee):null,lalamove_quotation_id:t.lalamove_quotation_id,lalamove_order_id:t.lalamove_order_id,lalamove_status:t.lalamove_status,lalamove_tracking_url:t.lalamove_tracking_url,order_items:t.order_items?.map(e=>({id:e.id,order_id:e.order_id,menu_item_id:e.menu_item_id,menu_item_name:e.menu_item_name,quantity:e.quantity,unit_price:Number(e.unit_price),total_price:Number(e.total_price),selected_variation:e.selected_variation,selected_add_ons:e.selected_add_ons,created_at:e.created_at}))||[]};return s.Z.json({order:o},{status:200})}catch(e){return console.error("Unexpected error in GET /api/orders/[id]:",e),s.Z.json({error:"Internal server error"},{status:500})}}async function PATCH(e,{params:r}){try{let t=(0,n.DK)(e);t&&console.log("Admin order update - rate limiting bypassed");let{id:a}=r,o=await e.json(),{status:i,lalamove_order_id:l,lalamove_status:d,lalamove_tracking_url:_}=o;if(!a)return s.Z.json({error:"Order ID is required"},{status:400});let u={};if(void 0!==i){if(!["pending","confirmed","preparing","ready","out_for_delivery","completed","cancelled"].includes(i))return s.Z.json({error:"Invalid status"},{status:400});u.status=i}if(void 0!==l&&(u.lalamove_order_id=l),void 0!==d&&(u.lalamove_status=d),void 0!==_&&(u.lalamove_tracking_url=_),0===Object.keys(u).length)return s.Z.json({error:"No fields to update"},{status:400});let{data:m}=await n.RU.from("orders").select("*").eq("id",a).single(),c="confirmed"===i&&m?.status!=="confirmed"&&m?.service_type==="delivery"&&m?.lalamove_quotation_id&&!m?.lalamove_order_id,{data:p,error:v}=await n.RU.from("orders").update(u).eq("id",a).select(`
        *,
        order_items (*)
      `).single();if(v)return console.error("Error updating order:",v),s.Z.json({error:"Failed to update order",details:v.message},{status:500});if(!p)return s.Z.json({error:"Order not found"},{status:404});c&&(async()=>{try{let r=await getSiteSettings();if(r){let t=buildLalamoveConfig(r);if(t&&p.lalamove_quotation_id){let r=function(e){if(!e)return;let r=e.trim();if(!r)return;let t=r.replace(/\D/g,"");if(t)return t.startsWith("63")?`+${t}`:t.startsWith("0")?`+63${t.slice(1)}`:t.startsWith("9")?`+63${t}`:`+63${t}`}(p.contact_number)||p.contact_number,o=await createLalamoveOrder(p.lalamove_quotation_id,p.customer_name,r,t,p.id,e);o?(await n.RU.from("orders").update({lalamove_order_id:o.orderId,lalamove_status:o.status,lalamove_tracking_url:o.shareLink}).eq("id",a),console.log(`Lalamove order created automatically for order ${p.order_number}:`,o.orderId)):console.warn(`Failed to create Lalamove order for order ${p.order_number}`)}}}catch(e){console.error("Error creating Lalamove order automatically:",e)}})();let g={id:p.id,order_number:p.order_number,customer_name:p.customer_name,contact_number:p.contact_number,service_type:p.service_type,address:p.address,landmark:p.landmark,pickup_time:p.pickup_time,party_size:p.party_size,dine_in_time:p.dine_in_time,payment_method:p.payment_method,reference_number:p.reference_number,status:p.status,total:Number(p.total),notes:p.notes,customer_ip:p.customer_ip,created_at:p.created_at,updated_at:p.updated_at,completed_at:p.completed_at,delivery_fee:p.delivery_fee?Number(p.delivery_fee):null,lalamove_quotation_id:p.lalamove_quotation_id,lalamove_order_id:p.lalamove_order_id,lalamove_status:p.lalamove_status,lalamove_tracking_url:p.lalamove_tracking_url,order_items:p.order_items?.map(e=>({id:e.id,order_id:e.order_id,menu_item_id:e.menu_item_id,menu_item_name:e.menu_item_name,quantity:e.quantity,unit_price:Number(e.unit_price),total_price:Number(e.total_price),selected_variation:e.selected_variation,selected_add_ons:e.selected_add_ons,created_at:e.created_at}))||[]};return s.Z.json({order:g},{status:200})}catch(e){return console.error("Unexpected error in PATCH /api/orders/[id]:",e),s.Z.json({error:"Internal server error"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/[id]/route",pathname:"/api/orders/[id]",filename:"route",bundlePath:"app/api/orders/[id]/route"},resolvedPagePath:"/Users/codemedavid/Documents/starrs/Starr-s-Famous-Shakes/app/api/orders/[id]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:u,serverHooks:m,headerHooks:c,staticGenerationBailout:p}=d,v="/api/orders/[id]/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[955,771,97],()=>__webpack_exec__(8594));module.exports=t})();